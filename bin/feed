#!/bin/sh -e
#
# Create the list of posts for RSS feed.
#

convert() {
    read post
    read _
    read date
    read time

    part=$(echo "$post" | sed 's/\.html$/.part.html/')
    title=$(head -1 "$part" | sed 's,<title>,,;s,</title>,,')
    path=$(echo "$post" | sed 's,public/,,')
    url="https://www.codejam.info/$path"

    echo "$time~$title~$url~$date~$part"
}

main() {
    for post in "$@"; do
        md=$(echo "$post" | sed 's/\.html$/\.md/')
        (echo "$post"; bin/meta < "$md") | convert
    done
}

main "$@" | sort -r | while IFS='~' read time title url date part; do
    cat << EOF
<item>
<title>$title</title>
<link>$url</link>
<guid>$url</guid>
<pubDate>$date</pubDate>
<description><![CDATA[
$(sed '1,3d' "$part")
]]></description>
</item>
EOF
done
